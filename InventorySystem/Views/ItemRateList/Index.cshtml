@{
    Layout = "_Layout";
}
<link href="~/css/itemratelist.css" rel="stylesheet" />

<main class="main-content">
    <div class="page-header">
        <h2>Item Rate Management</h2>
        <p style="color: var(--text-secondary);">View and manage item pricing and rates</p>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <div class="filter-grid">
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-control" id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search items...">
            </div>

            <div class="form-group" style="display: flex; align-items: flex-end;">
                <button class="btn btn-primary" style="width: 100%;" onclick="loadItems()">🔍 Filter</button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Item Rate List</h3>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Item ID</th>
                        <th>Category Name</th>
                        <th>Item Name</th>
                        <th>Size</th>
                        <th>Sale Price</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- rows dynamically generated here -->
                </tbody>
            </table>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="loadItems()">🔄 Refresh</button>
@*             <button type="button" class="btn btn-success">💾 Save</button> *@
        </div>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadCategories();
        loadItems();
    });

    async function loadCategories() {
        try {
            const response = await fetch('/ItemRateList/GetCategories');
            const data = await response.json();
            const dropdown = document.getElementById("categoryFilter");
            dropdown.innerHTML = '<option value="">All Categories</option>';
            data.forEach(cat => {
                dropdown.innerHTML += `<option value="${cat.categoryId}">${cat.categoryName}</option>`;
            });
        } catch (error) {
            console.error("Error loading categories:", error);
        }
    }

    async function loadItems() {
        const categoryId = document.getElementById("categoryFilter").value || "";
        const search = document.getElementById("searchInput").value.toLowerCase();
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";

        try {
            const response = await fetch(`/ItemRateList/GetItems?categoryId=${categoryId}`);
            const data = await response.json();

                const filtered = data.filter(item =>
        (item.itemName?.toLowerCase() || "").includes(search) ||
        (item.categoryName?.toLowerCase() || "").includes(search)
    );


            tbody.innerHTML = "";
            filtered.forEach(item => {
                const row = `
                    <tr onclick="toggleExpand(this)">
                        <td><span class="expand-icon">▶</span></td>
                        <td>${item.itemID}</td>
                        <td>${item.categoryName}</td>
                        <td>${item.itemName || ""}</td>
                        <td>${item.size || "-"}</td>
                        <td>${item.salePrice?.toFixed(2)}</td>
                    </tr>
                    <tr class="nested-row" style="display:none;">
                        <td colspan="11" style="padding:1rem;background:#f8f9fa;">
                            <table class="nested-table">
                                <thead>
                                    <tr>
                                        <th>Item ID</th>
                                        <th>Category</th>
                                        <th>Item Name</th>
                                        <th>Size</th>
                                        <th>Sale Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${item.itemID}</td>
                                        <td>${item.categoryName || ""}</td>
                                        <td>${item.itemName || ""}</td>
                                        <td>${item.size || "-"}</td>
                                        <td>${item.salePrice?.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        } catch (error) {
            console.error("Error loading items:", error);
            tbody.innerHTML = "<tr><td colspan='11'>Error loading data.</td></tr>";
        }
    }

    function toggleExpand(row) {
        const nextRow = row.nextElementSibling;
        const icon = row.querySelector('.expand-icon');

        if (nextRow && nextRow.classList.contains('nested-row')) {
            const isVisible = nextRow.style.display === 'table-row';
            nextRow.style.display = isVisible ? 'none' : 'table-row';
            icon.textContent = isVisible ? '▶' : '▼';
        }

        document.querySelectorAll('.data-table tbody tr:not(.nested-row)')
            .forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
    }
</script>
